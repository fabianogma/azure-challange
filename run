#!/usr/bin/env bash

blue='\033[0;34m'
green='\033[0;32m'
nc='\033[0m'

# To do list, criar funções:
# 1 storage account
# 2 config de variaveis de backend
# 3 para iniciar o terraform
# 4 função pra destruir/limpar ambiente
# 5 função de git push

if [ -z "$@" ]; then
    echo -e "o que você que executar?\n
    1- Git commit: ./run git-commit
    2- Terraform: ./run tf
    3- Terraform remote tfstate: ./run tfstate
    4- Limpar deploy: ./run clear"
    exit 0

else

    tf() {
        dir="-chdir=terraform/env"
        echo -e "Importando provider:"
        terraform $dir init

        if [ $? -eq 0 ]; then
            echo -e "\nValidate Status: "
            terraform $dir validate

            if [ $? -eq 0 ]; then
                echo -e "\nPlan Status: "
                terraform $dir plan -out=tfplan

                echo -e "\n"
                read -p "Press enter to start Apply or CTRL+C to finish the script."

                if [ $? -eq 0 ]; then
                    terraform $dir apply tfplan
                    exit 0
                fi
            fi
        fi
    }

    tfstate() {
        rg_name=tfstate
        stg_name=tfstatedesafiodevops
        cnt_name=tfstate
        PS3='Selecione o número desejado: '

        az account show >/dev/null 2>&1

        if [ $? -gt 0 ]; then
            echo -e "\n${blue}Você não está logado, por favor, realizar login:${nc}"
            az login --use-device-code
        fi

        echo -e "\n${blue}Atualmente você está logado na subscription: ${nc}"
        az account show --output table

        echo -e "\n${blue}Change subscription?${nc}"

        select yn in "Yes" "No"; do
            case $yn in
            Yes)
                echo -e "\n${blue}Lista de subscription disponiveis:${nc}"
                az account list -o table

                printf "\n${blue}Digite a subscription a ser utilizada:${nc}"
                read subscription

                az account set -s "${subscription}"

                while [ $? -gt 0 ]; do
                    printf "\n${blue}Subscription invalida! Digite novamente: ${nc}"
                    read subscription

                    az account set -s "${subscription}"
                done

                az account list -o table

                echo
                break
                ;;
            No)
                break
                ;;
            *)
                echo "Opção inválida"
                ;;
            esac
        done

        # Create resource group
        az group create --name $rg_name --location eastus

        # Create storage account
        az storage account create --resource-group $rg_name --name $stg_name --sku Standard_LRS --encryption-services blob

        # Create blob container
        az storage container create --name $cnt_name --account-name $stg_name

        account_key=$(az storage account keys list --resource-group $RESOURCE_GROUP_NAME --account-name $STORAGE_ACCOUNT_NAME --query '[0].value' -o tsv)
        export TF_ACCESS_KEY=$account_key
    }

    git-commit() {
        branch=$(git symbolic-ref HEAD | sed -e "s/^refs\/heads\///")

        git add .

        printf "${blue}Mensagem do commit: ${green}"
        read commitMessage

        git commit -m "$commitMessage" >/dev/null

        echo -e "\n${blue}Push:${green}"
        git push origin ${branch}
    }
fi

"$@"
